# Legacy-compatible CPU Dockerfile without BuildKit features
#
# Use this when `docker buildx` / BuildKit isn't available on your system.
# It mirrors the intent of docker/Dockerfile.cpu but avoids `RUN --mount=...`
# and other BuildKit-only syntax.
#
# Build targets:
#   - vllm-build: builds a CPU wheel
#   - vllm-test: installs the wheel and test deps, ready to run pytest
#
# Example usage:
#   docker build -f docker/Dockerfile.cpu.legacy --target vllm-test -t vllm-cpu-test .
#   docker run --rm -e VLLM_USE_V1=1 vllm-cpu-test bash -lc "pytest tests/v1/test_min_tokens.py -v"

######################### BASE IMAGE #########################
FROM ubuntu:22.04 AS base

ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /workspace/

# Install system deps
RUN apt-get update -y \
    && apt-get install -y --no-install-recommends \
        ca-certificates curl wget git jq lsof \
        build-essential cmake \
        gcc-12 g++-12 \
        libtcmalloc-minimal4 libnuma-dev \
        ffmpeg libsm6 libxext6 libgl1 \
        xz-utils pkg-config \
    && update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 10 --slave /usr/bin/g++ g++ /usr/bin/g++-12 \
    && rm -rf /var/lib/apt/lists/*

# Install uv and a Python 3.12 virtualenv (avoids PPA complexity)
ENV PATH="/root/.local/bin:$PATH"
ENV VIRTUAL_ENV="/opt/venv"
ENV UV_PYTHON_INSTALL_DIR=/opt/uv/python
RUN curl -LsSf https://astral.sh/uv/install.sh | sh \
    && uv venv --python 3.12 --seed ${VIRTUAL_ENV}
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

# Prefer PyTorch CPU wheels
ENV PIP_EXTRA_INDEX_URL="https://download.pytorch.org/whl/cpu"

######################### BUILD WHEEL #########################
FROM base AS vllm-build
WORKDIR /workspace/vllm

# Optional: build-time toggle to generate a baseline image with full-row swap
# 0 = optimized (default), 1 = baseline (full-row copy in swap_states)
ARG VLLM_BASELINE_SWAP=0

# Copy only files needed for dependency installation first (improves caching)
COPY requirements/ ./requirements/

# Upgrade pip and install build/runtime deps for CPU
RUN python -m pip install --upgrade pip \
    && python -m pip install -r requirements/cpu-build.txt \
    && python -m pip install -r requirements/cpu.txt

# Copy the full repo and build the wheel
COPY . .

# If requested, rewrite swap_states to baseline full-row copy before building
RUN if [ "$VLLM_BASELINE_SWAP" = "1" ]; then \
      python - <<'PY' ; \
import io, sys
p = 'vllm/v1/worker/gpu_input_batch.py'
s = open(p, 'r', encoding='utf-8').read().splitlines()
out = []
i = 0
while i < len(s):
    line = s[i]
    if 'Optimization: only copy valid indices' in line:
        out.append(line)
        i += 1
        # Skip blank lines
        while i < len(s) and s[i].strip() == '':
            out.append(s[i]); i += 1
        # Drop lines that compute num_tokens_i1/num_tokens_i2/max_tokens
        while i < len(s) and (('num_tokens_i1' in s[i]) or ('num_tokens_i2' in s[i]) or ('max_tokens' in s[i])):
            i += 1
        # Replace the next three slice ops to use full row (:self.max_model_len)
        for _ in range(3):
            if i < len(s):
                out.append(s[i].replace(':max_tokens', ':self.max_model_len'))
                i += 1
        continue
    out.append(line)
    i += 1
open(p, 'w', encoding='utf-8').write('\n'.join(out))
PY
    fi

RUN VLLM_TARGET_DEVICE=cpu python setup.py bdist_wheel

######################### TEST IMAGE #########################
FROM base AS vllm-test
WORKDIR /workspace/

# Install vLLM wheel from builder
COPY --from=vllm-build /workspace/vllm/dist /dist
RUN python -m pip install --upgrade pip \
    && python -m pip install /dist/*.whl \
    && python -m pip install pytest

# Copy tests and minimal assets used by tests
COPY ./tests/ ./tests/
COPY ./examples/ ./examples/
COPY ./benchmarks/ ./benchmarks/

CMD ["bash"]